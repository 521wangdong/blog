<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>react组件封装 | 前端</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="王冬的个人博客">
    
    <link rel="preload" href="/blog/assets/css/0.styles.0b1ac558.css" as="style"><link rel="preload" href="/blog/assets/js/app.b199bffd.js" as="script"><link rel="preload" href="/blog/assets/js/2.5239c051.js" as="script"><link rel="preload" href="/blog/assets/js/16.ef875214.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.8711566b.js"><link rel="prefetch" href="/blog/assets/js/11.47db2a95.js"><link rel="prefetch" href="/blog/assets/js/12.97fcf21f.js"><link rel="prefetch" href="/blog/assets/js/13.185b2dd5.js"><link rel="prefetch" href="/blog/assets/js/14.a6e55d05.js"><link rel="prefetch" href="/blog/assets/js/15.7ade0bad.js"><link rel="prefetch" href="/blog/assets/js/17.2a263d49.js"><link rel="prefetch" href="/blog/assets/js/18.55103cda.js"><link rel="prefetch" href="/blog/assets/js/19.a369c423.js"><link rel="prefetch" href="/blog/assets/js/20.fc252d8c.js"><link rel="prefetch" href="/blog/assets/js/3.835a6fd6.js"><link rel="prefetch" href="/blog/assets/js/4.c453bc54.js"><link rel="prefetch" href="/blog/assets/js/5.76fc70b2.js"><link rel="prefetch" href="/blog/assets/js/6.498ab014.js"><link rel="prefetch" href="/blog/assets/js/7.3822cadf.js"><link rel="prefetch" href="/blog/assets/js/8.53b6a155.js"><link rel="prefetch" href="/blog/assets/js/9.01deef7e.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.0b1ac558.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">前端</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/home/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/js/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TypeScript
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  Webpack
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/home/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/react/" class="nav-link router-link-active">
  React
</a></div><div class="nav-item"><a href="/blog/vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/blog/js/" class="nav-link">
  Js
</a></div><div class="nav-item"><a href="/blog/typescript/" class="nav-link">
  TypeScript
</a></div><div class="nav-item"><a href="/blog/webpack/" class="nav-link">
  Webpack
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog/react/" aria-current="page" class="sidebar-link">React</a></li><li><a href="/blog/react/React开发技巧.html" class="sidebar-link">React开发技巧</a></li><li><a href="/blog/react/ReactHooks.html" class="sidebar-link">React Hooks</a></li><li><a href="/blog/react/生命周期.html" class="sidebar-link">react 生命周期</a></li><li><a href="/blog/react/路由.html" class="sidebar-link">路由 React Router V5</a></li><li><a href="/blog/react/组件封装.html" class="active sidebar-link">react组件封装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/react/组件封装.html#水印组件封装" class="sidebar-link">水印组件封装</a></li></ul></li><li><a href="/blog/react/Dva.html" class="sidebar-link">Dva</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react组件封装"><a href="#react组件封装" class="header-anchor">#</a> react组件封装</h1> <h2 id="水印组件封装"><a href="#水印组件封装" class="header-anchor">#</a> 水印组件封装</h2> <p>使用Canvas 生成水印，并使用 MutationObserve （可以监听DOM结构变化的接口）监视 DOM 的变动，使得水印不可被删除、且属性不可被修改</p> <p>源码如下</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> React <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> watermark <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../../utils/watermark'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">WaterMark</span> <span class="token keyword">extends</span> <span class="token class-name">React<span class="token punctuation">.</span>Component</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> style<span class="token punctuation">,</span> <span class="token operator">...</span>options <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">;</span>
    <span class="token function">watermark</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      container<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">,</span>
      <span class="token operator">...</span>options<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token punctuation">{</span>
      position<span class="token operator">:</span> <span class="token string">'relative'</span><span class="token punctuation">,</span>
      <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>style<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div ref<span class="token operator">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token parameter">el</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container <span class="token operator">=</span> el<span class="token punctuation">}</span> id<span class="token operator">=</span><span class="token string">&quot;watermark&quot;</span> style<span class="token operator">=</span><span class="token punctuation">{</span>style<span class="token punctuation">}</span><span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>children<span class="token punctuation">}</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>watermark方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">watermark</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span>
    container <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token comment">// 容器</span>
    width <span class="token operator">=</span> <span class="token string">'300'</span><span class="token punctuation">,</span> <span class="token comment">// canvas元素宽</span>
    height <span class="token operator">=</span> <span class="token string">'200'</span><span class="token punctuation">,</span> <span class="token comment">// canvas元素高</span>
    textAlign <span class="token operator">=</span> <span class="token string">'left'</span><span class="token punctuation">,</span> <span class="token comment">// 文字对齐</span>
    textBaseline <span class="token operator">=</span> <span class="token string">'bottom'</span><span class="token punctuation">,</span> <span class="token comment">// 基准线</span>
    font <span class="token operator">=</span> <span class="token string">'16px Microsoft Yahei'</span><span class="token punctuation">,</span> <span class="token comment">// 字体大小及样式</span>
    fillStyle <span class="token operator">=</span> <span class="token string">'#000'</span><span class="token punctuation">,</span> <span class="token comment">// 自定义水印的颜色</span>
    content <span class="token operator">=</span> <span class="token string">'内部文档，请勿外传'</span><span class="token punctuation">,</span> <span class="token comment">// 水印内容</span>
    globalAlpha <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// 设置图形和图像透明度的值</span>
    rotate <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token comment">// 文字旋转角度</span>
    zIndex <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token comment">// 元素堆叠顺序</span>
  <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span>

  <span class="token keyword">let</span> canvas <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'canvas'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'width'</span><span class="token punctuation">,</span> width<span class="token punctuation">)</span><span class="token punctuation">;</span>
  canvas<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'height'</span><span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> ctx <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token string">'2d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取 canvas2d 上下文</span>
  ctx<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> globalAlpha<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>textAlign <span class="token operator">=</span> textAlign<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>textBaseline <span class="token operator">=</span> textBaseline<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>font <span class="token operator">=</span> font<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>fillStyle <span class="token operator">=</span> fillStyle<span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> rotate<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">180</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span><span class="token function">fillText</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> base64Url <span class="token operator">=</span> canvas<span class="token punctuation">.</span><span class="token function">toDataURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回一个包含图片展示的 data URI</span>

  <span class="token keyword">const</span> __wm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.__wm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//选择器</span>
  <span class="token keyword">const</span> watermarkDiv <span class="token operator">=</span> __wm <span class="token operator">||</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> styleStr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    position:absolute;
    top:0px;
    left:0px;
    width:100%;
    height:100%;
    z-index:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>zIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">;
    pointer-events:none;
    background-repeat:repeat;
    background-image:url('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>base64Url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">')</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

  watermarkDiv<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">,</span> styleStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  watermarkDiv<span class="token punctuation">.</span>classList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'__wm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 为元素添加“__wm”类名</span>

  container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'relative'</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__wm<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>watermarkDiv<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 添加元素</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> MutationObserver <span class="token operator">=</span> window<span class="token punctuation">.</span>MutationObserver <span class="token operator">||</span> window<span class="token punctuation">.</span>WebKitMutationObserver<span class="token punctuation">;</span>
  <span class="token comment">// 检查浏览器是否支持这个API</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>MutationObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> args <span class="token operator">=</span> arguments<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> __wm <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.__wm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 只在__wm元素变动才重新调用</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>__wm <span class="token operator">&amp;&amp;</span> __wm<span class="token punctuation">.</span><span class="token function">getAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> styleStr<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>__wm <span class="token operator">||</span> container<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">!==</span> <span class="token string">'relative'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 避免一直触发</span>
        mo<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">watermark</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      attributes<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 观察目标节点的属性节点</span>
      subtree<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 观察目标节点的所有后代节点</span>
      childList<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 观察目标节点的子节点</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>使用MutationObserve ，当水印组件被删除、属性被修改或水印组件的容器定位属性 position 不为 relative时，会重新调用watermark方法</p> <p>MutationObserver给开发者们提供了一种能在某个范围内的DOM树发生变化时作出适当反应的能力</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/react/路由.html" class="prev">
        路由 React Router V5
      </a></span> <span class="next"><a href="/blog/react/Dva.html">
        Dva
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.b199bffd.js" defer></script><script src="/blog/assets/js/2.5239c051.js" defer></script><script src="/blog/assets/js/16.ef875214.js" defer></script>
  </body>
</html>
